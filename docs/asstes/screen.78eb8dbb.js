import{d as S,r as l,v as j,b as q,E as F,e as M,o as u,c as E,f as y,w as C,g as p,a as N,u as T,l as z,h as I}from"./index.0d7979c4.js";const G={className:"screen"},H=I("\u5C4F\u5E55\u5171\u4EAB"),J=I("\u6444\u50CF\u5934"),K=I("\u8FDB\u5165\u623F\u95F4"),Q=N("div",{id:"remoteVideo"},null,-1),Y=S({__name:"screen",setup(W){const b=T(),m=l(b.query.room),f=l(b.query.type),r=l(j()),D=l(Math.random()),d=l(),w=new Map,_=l(!1);let c,i,g=l([]);const U=q.create({baseURL:"https://114.55.34.57:7070/",timeout:4e4}),x=async()=>{i=await navigator.mediaDevices.getDisplayMedia({audio:!0,video:{width:1920,height:1080,frameRate:60}}),d.value.srcObject=i,d.value.play();const e=g.value.filter(t=>t[0]!==r.value);for(const t of e){const o=await v(r.value,t[0]);await k(t[0],o)}},B=async()=>{i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),d.value.srcObject=i,d.value.play();const e=g.value.filter(t=>t[0]!==r.value);for(const t of e){const o=await v(r.value,t[0]);await k(t[0],o)}},L=()=>{c=z("https://114.55.34.57:7070/",{query:{room:m.value,userId:r.value,nick:D.value}}),A(),_.value=!0},A=()=>{c.on("join",e=>{O(e)}),c.on("offer",$),c.on("answer",P),c.on("ICE-candidate",R)},v=async(e,t)=>{const o=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return o.onicecandidate=n=>{console.log("-> onicecandidate",n),n.candidate&&c.emit("ICE-candidate",{creatorUserId:e,recUserId:t,sdp:n.candidate},s=>{console.log(s)})},o.ontrack=n=>{const s=n.streams[0].id,V=document.querySelector("#remoteVideo");let h=document.querySelector(`#PLV${s}`);if(!h){const a=document.createElement("div");a.setAttribute("id",`PLV${s}`),V&&V.appendChild(a),h=a}if(n.track.kind==="video"){const a=document.createElement("video");a.srcObject=n.streams[0],a.autoplay=!0,a.style.setProperty("width","100vw"),a.style.setProperty("height","100vh"),a.style.setProperty("aspect-ratio","16 / 9"),a.setAttribute("id",n.track.id),a.setAttribute("auto-play","true"),h.appendChild(a)}if(n.track.kind==="audio"){const a=document.createElement("audio");a.srcObject=n.streams[0],a.autoplay=!0,a.setAttribute("id",n.track.id),h.appendChild(a)}},o.onconnectionstatechange=n=>{console.log(o.connectionState,"onconnectionstatechange")},w.set(`${e}_${t}`,o),o};setInterval(()=>{U.get("/userlist",{params:{room:m.value}}).then(e=>{g.value=e.data})},1e3);async function O(e){if(!i)return;const t=await v(r.value,e);await k(e,t)}const k=async(e,t,o=i)=>{if(!i)return;o.getTracks().forEach(s=>{t.addTrack(s,o)});const n=await t.createOffer();await t.setLocalDescription(n),console.log("-> offer",n),c.emit("offer",{creatorUserId:r.value,sdp:n,recUserId:e},s=>{console.log(s)})},$=async e=>{const t=await v(e.creatorUserId,e.recUserId);console.log("-> handleOffer",e.sdp),await t.setRemoteDescription(e.sdp);const o=await t.createAnswer();console.log("-> answer",o),await t.setLocalDescription(o),c.emit("answer",{recUserId:r.value,sdp:o,creatorUserId:e.creatorUserId},n=>{console.log(n)})},P=async e=>{const t=w.get(`${e.creatorUserId}_${e.recUserId}`);if(console.log("-> handleAnswer",e),!t){console.warn("handleAnswer peer \u83B7\u53D6\u5931\u8D25");return}await t.setRemoteDescription(e.sdp)},R=async e=>{const t=w.get(`${e.creatorUserId}_${e.recUserId}`);if(console.log("-> handleIce",e),!t){console.warn("handleIce peer \u83B7\u53D6\u5931\u8D25");return}await t.addIceCandidate(e.sdp)};return(e,t)=>{const o=F,n=M;return u(),E("div",G,[f.value==="host"?(u(),y(o,{key:0,onClick:x},{default:C(()=>[H]),_:1})):p("",!0),f.value==="host"?(u(),y(o,{key:1,onClick:B},{default:C(()=>[J]),_:1})):p("",!0),_.value?p("",!0):(u(),y(n,{key:2,modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=s=>m.value=s)},null,8,["modelValue"])),_.value?p("",!0):(u(),y(o,{key:3,onClick:L},{default:C(()=>[K]),_:1})),f.value==="host"?(u(),E("video",{key:4,autoplay:"",ref_key:"screenVideo",ref:d,id:"screenVideo"},null,512)):p("",!0),Q])}}});export{Y as default};
